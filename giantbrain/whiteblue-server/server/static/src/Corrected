import React from 'react';
import ReactDOM from 'react-dom';
import 'whatwg-fetch';
import { Link } from 'react-router-dom';
import gql from "graphql-tag";
import { Query, Mutation } from "react-apollo";
import moment from 'moment';

import Loading from './Loading.js';

	export default class Assessment extends React.Component {
				constructor(props){
					super(props);
          this.state = {
            cursorQuestionState : 0,
			currentQuestion : "",
			currentAnswer : "",
          };
          this.nextQuestion = this.nextQuestion.bind(this);
          this.previousQuestion = this.previousQuestion.bind(this);
          this.pushedQuestion = this.pushedQuestion.bind(this);
		  this.ChoiceAnswers = this.ChoiceAnswers.bind(this);
		}
		ChoiceAnswers(e){
			this.setState({ currentAnswer : e.target.value });
		}
        pushedQuestion(d,index){
			let { questId } = d;
          this.setState({ cursorQuestionState : index,
							currentQuestion : questId
		  });
        }
        previousQuestion(){
          let previousedQuestion = this.state.cursorQuestionState;
          let newpreviousedQuestion = previousedQuestion-1;
          this.setState({
                  cursorQuestionState : newpreviousedQuestion
          });
        }
        nextQuestion(){
          let followedQuestion = this.state.cursorQuestionState;
          let newfollowedQuestion = followedQuestion+1;
          this.setState({
                  cursorQuestionState : newfollowedQuestion
          });
        }
				render(){
					const GET_ASSESS = gql`
					query ($id: String){
					  getAnAssess(id: $id) {
							Id
							_id
							header
							fields
							promotionId
							courseId
							teacherId
							description
							startDay
							endDay
							duration
							questionList {
							  questId
							  text
							  type
							  GAV
							  assertions {
								text
								answerId
							  }
							  correctAnswer
							}
						  } 
						}
						`;
						
						const SAVE_ANSWERS = gql`
									mutation onSubmitAnswersToQuestions($ownerId :String,$questId :String,$assessId :String,$answerId :String){
									  onSubmitAnswersToQuestions(ownerId :$ownerId,questId :$questId,assessId :$assessId,answerId :$answerId){
										_id
										starttime
										endtime
										ownerId
										assessId
										answersCorrect{
										  answerIdSubmit
										  questIdResponded
										  submitedtime
										}
									  }
									}
									`;
		const id = this.props.match.params.id.toString();
		const  { cursorQuestionState } = this.state;
		return (
			<Query query={GET_ASSESS} variables={{ id }}>
				{({ data :{ getAnAssess },loading, error})=>{
					if (loading || !getAnAssess) {
						return <Loading />;
					  }
					return (
							<div className="col-lg-12 content-position" >
								<div className="row" >
									<div className="col-lg-6 fixed-position more-rised-position white-space shadow-style">
										<div className="person-name"> Par <span > {getAnAssess.teacherId}</span></div>
										<div className="course-name"> {getAnAssess.courseId}</div>
										<div className="topic-name"> Topic : {getAnAssess.header}</div>
										<div > Available time {getAnAssess.endDay} - {getAnAssess.startDay}</div>
										<div id="Bar">
					  						<div id="time-flow"/>
										</div>
									</div>
									<div className="row" >
										<div className="col-lg-6 core_asset" >
										<div><span  className="questions"> Question :{getAnAssess.questionList[cursorQuestionState].text}</span></div>
												<div>
													{getAnAssess.questionList[cursorQuestionState].assertions.
															map((assertion,key)=> (
															  <div>
																<input type="radio" 
																	id={key} 
																	value={assertion.answerId} 
																	name="answer"
																	onChange={(e)=>this.ChoiceAnswers(e)}
																/>
																<label for={key}>{assertion.text}</label>
															  </div>  
															))
													  }
												</div>	
												<Mutation mutation={SAVE_ANSWERS}>
												{(onSubmitAnswersToQuestions, { data })=>{
													return (<button onClick={()=>{
																onSubmitAnswersToQuestions({ variables: {
																	ownerId :"5dd83d6db770581478f9b273",
																	answerId : this.state.currentAnswer,
																	assessId: id,
																	questId: this.state.currentQuestion,
																}})
															}}>
																send
															</button>)
												}}
											</Mutation>	
										</div>
									</div>
								</div>
								<div className="pagination">
									  <a href="#" onClick={()=> this.previousQuestion()}><i className="fa fa-chevron-left"/></a>
									   {getAnAssess.questionList.map(
											(d,index)=>(<a href="#" onClick={()=> this.pushedQuestion(d,index)}>{index+1}</a>)
										)}
									  <a href="#" onClick={()=> this.nextQuestion()}><i className="fa fa-chevron-right"/></a>
								</div> 
							</div>
							)}}
			</Query>);
				}	
			
		}